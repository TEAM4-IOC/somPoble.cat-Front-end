<div class="component-wrapper">
  <div class="auth-container">
    <h1>SomPoble</h1>
    <ng-container *ngIf="enterprise$ | async as emp; else cargando">
      <ng-container *ngIf="emp.length === 0; else edicionEmpresa">
        <ng-container *ngIf="!selectedRole">
          <h2>{{ 'empresa.select_role_title' | translate }}</h2>
          <div class="role-selection">
            <select #roleSelect (change)="selectRole(+roleSelect.value)">
              <option value="" disabled selected>{{ 'empresa.select_role_placeholder' | translate }}</option>
              <option value="1">{{ 'empresa.option_empresari' | translate }}</option>
              <option value="2">{{ 'empresa.option_autonom' | translate }}</option>
            </select>
          </div>
        </ng-container>

        <ng-container *ngIf="selectedRole">
          <h2 *ngIf="selectedRole === 1">{{ 'empresa.register_title_empresari' | translate }}</h2>
          <h2 *ngIf="selectedRole === 2">{{ 'empresa.register_title_autonom' | translate }}</h2>

          <form (ngSubmit)="onSubmit()" #empresaForm="ngForm">
            <div class="input-group">
              <label for="identificadorFiscal" class="form-label">
                {{ selectedRole === 1
                    ? ('empresa.identificadorFiscal_label_empresari' | translate)
                    : ('empresa.identificadorFiscal_label_autonom' | translate)
                }}
              </label>
              <div class="input-control">
                <input
                  type="text"
                  id="identificadorFiscal"
                  [(ngModel)]="identificadorFiscal"
                  name="identificadorFiscal"
                  [placeholder]="selectedRole === 1
                    ? ('empresa.identificadorFiscal_placeholder_empresari' | translate)
                    : ('empresa.identificadorFiscal_placeholder_autonom' | translate)"
                  required
                  pattern="[0-9]{8,9}[A-Za-z]?"
                  #identificadorFiscalModel="ngModel"
                />
              </div>
              <div class="error" *ngIf="identificadorFiscalModel.invalid && (identificadorFiscalModel.touched || identificadorFiscalModel.dirty)">
                {{ 'empresa.identificadorFiscal_error' | translate }}
              </div>
            </div>

            <ng-container *ngIf="selectedRole === 1; else autonomoBlock">
              <div class="input-group">
                <label for="nombre" class="form-label">{{ 'empresa.nombre_label' | translate }}</label>
                <div class="input-control">
                  <input
                    type="text"
                    id="nombre"
                    [(ngModel)]="nombre"
                    name="nombre"
                    placeholder="{{ 'empresa.nombre_placeholder' | translate }}"
                    required
                    minlength="2"
                    #nombreModel="ngModel"
                  />
                </div>
                <div class="error" *ngIf="nombreModel.invalid && (nombreModel.touched || nombreModel.dirty)">
                  {{ 'empresa.nombre_error' | translate }}
                </div>
              </div>
            </ng-container>
            <ng-template #autonomoBlock>
              <div class="input-group">
                <label for="actividad" class="form-label">{{ 'empresa.actividad_label' | translate }}</label>
                <div class="input-control">
                  <input
                    type="text"
                    id="actividad"
                    [(ngModel)]="actividad"
                    name="actividad"
                    placeholder="{{ 'empresa.actividad_placeholder' | translate }}"
                    required
                    minlength="2"
                    #actividadModel="ngModel"
                  />
                </div>
                <div class="error" *ngIf="actividadModel.invalid && (actividadModel.touched || actividadModel.dirty)">
                  {{ 'empresa.actividad_error' | translate }}
                </div>
              </div>
            </ng-template>

            <div class="input-group">
              <label for="direccion" class="form-label">{{ 'empresa.direccion_label' | translate }}</label>
              <div class="input-control">
                <input
                  type="text"
                  id="direccion"
                  [(ngModel)]="direccion"
                  name="direccion"
                  placeholder="{{ 'empresa.direccion_placeholder' | translate }}"
                  required
                  minlength="2"
                  #direccionModel="ngModel"
                />
              </div>
              <div class="error" *ngIf="direccionModel.invalid && (direccionModel.touched || direccionModel.dirty)">
                {{ 'empresa.direccion_error' | translate }}
              </div>
            </div>

            <div class="input-group">
              <label for="email" class="form-label">{{ 'empresa.email_label' | translate }}</label>
              <div class="input-control">
                <input
                  type="email"
                  id="email"
                  [(ngModel)]="email"
                  name="email"
                  placeholder="{{ 'empresa.email_placeholder' | translate }}"
                  required
                  email
                  #emailModel="ngModel"
                />
              </div>
              <div class="error" *ngIf="emailModel.invalid && (emailModel.touched || emailModel.dirty)">
                {{ 'empresa.email_error' | translate }}
              </div>
            </div>

            <div class="input-group">
              <label for="telefono" class="form-label">{{ 'empresa.telefono_label' | translate }}</label>
              <div class="input-control">
                <input
                  type="text"
                  id="telefono"
                  [(ngModel)]="telefono"
                  name="telefono"
                  placeholder="{{ 'empresa.telefono_placeholder' | translate }}"
                  required
                  pattern="[0-9]{9}"
                  #telefonoModel="ngModel"
                />
              </div>
              <div class="error" *ngIf="telefonoModel.invalid && (telefonoModel.touched || telefonoModel.dirty)">
                {{ 'empresa.telefono_error' | translate }}
              </div>
            </div>

            <button type="submit" class="auth-btn" [disabled]="empresaForm.invalid">
              {{ 'empresa.submit_button' | translate }}
            </button>

            <div class="error" *ngIf="formError">{{ formError }}</div>
          </form>
        </ng-container>
      </ng-container>

      <ng-template #edicionEmpresa>
        <h2>
          {{ emp[0].tipo === 1
            ? ('empresa.register_title_empresari' | translate)
            : ('empresa.register_title_autonom' | translate)
          }}
        </h2>
        <div class="read-only-data">
          <div class="data-field">
            <label>
              {{ emp[0].tipo === 1
                ? ('empresa.identificadorFiscal_label_empresari' | translate)
                : ('empresa.identificadorFiscal_label_autonom' | translate)
              }}
            </label>
            <ng-container *ngIf="!editingField('identificadorFiscal'); else editIdent">
              <span>{{ emp[0].identificadorFiscal }}</span>
              <button class="icon-btn" (click)="startEditing('identificadorFiscal', emp[0].identificadorFiscal)">
                <i class="fas fa-edit"></i>
              </button>
            </ng-container>
            <ng-template #editIdent>
              <input type="text" [(ngModel)]="tempValue" pattern="[0-9]{8,9}[A-Za-z]?" />
              <button class="icon-btn" (click)="confirmEditing('identificadorFiscal', emp[0].identificadorFiscal)">
                <i class="fas fa-check"></i>
              </button>
              <button class="icon-btn" (click)="cancelEditing()">
                <i class="fas fa-times"></i>
              </button>
            </ng-template>
          </div>

          <ng-container *ngIf="emp[0].tipo === 1; else autonomoBlock2">
            <div class="data-field">
              <label>{{ 'empresa.nombre_label' | translate }}</label>
              <ng-container *ngIf="!editingField('nombre'); else editNombre">
                <span>{{ emp[0].nombre }}</span>
                <button class="icon-btn" (click)="startEditing('nombre', emp[0].nombre || '')">
                  <i class="fas fa-edit"></i>
                </button>
              </ng-container>
              <ng-template #editNombre>
                <input type="text" [(ngModel)]="tempValue" />
                <button class="icon-btn" (click)="confirmEditing('nombre', emp[0].identificadorFiscal)">
                  <i class="fas fa-check"></i>
                </button>
                <button class="icon-btn" (click)="cancelEditing()">
                  <i class="fas fa-times"></i>
                </button>
              </ng-template>
            </div>
          </ng-container>
          <ng-template #autonomoBlock2>
            <div class="data-field">
              <label>{{ 'empresa.actividad_label' | translate }}</label>
              <ng-container *ngIf="!editingField('actividad'); else editActividad">
                <span>{{ emp[0].actividad }}</span>
                <button class="icon-btn" (click)="startEditing('actividad', emp[0].actividad || '')">
                  <i class="fas fa-edit"></i>
                </button>
              </ng-container>
              <ng-template #editActividad>
                <input type="text" [(ngModel)]="tempValue" />
                <button class="icon-btn" (click)="confirmEditing('actividad', emp[0].identificadorFiscal)">
                  <i class="fas fa-check"></i>
                </button>
                <button class="icon-btn" (click)="cancelEditing()">
                  <i class="fas fa-times"></i>
                </button>
              </ng-template>
            </div>
          </ng-template>

          <div class="data-field">
            <label>{{ 'empresa.direccion_label' | translate }}</label>
            <ng-container *ngIf="!editingField('direccion'); else editDireccion">
              <span>{{ emp[0].direccion }}</span>
              <button class="icon-btn" (click)="startEditing('direccion', emp[0].direccion)">
                <i class="fas fa-edit"></i>
              </button>
            </ng-container>
            <ng-template #editDireccion>
              <input type="text" [(ngModel)]="tempValue" />
              <button class="icon-btn" (click)="confirmEditing('direccion', emp[0].identificadorFiscal)">
                <i class="fas fa-check"></i>
              </button>
              <button class="icon-btn" (click)="cancelEditing()">
                <i class="fas fa-times"></i>
              </button>
            </ng-template>
          </div>

          <div class="data-field">
            <label>{{ 'empresa.email_label' | translate }}</label>
            <ng-container *ngIf="!editingField('email'); else editEmail">
              <span>{{ emp[0].email }}</span>
              <button class="icon-btn" (click)="startEditing('email', emp[0].email)">
                <i class="fas fa-edit"></i>
              </button>
            </ng-container>
            <ng-template #editEmail>
              <input type="email" [(ngModel)]="tempValue" />
              <button class="icon-btn" (click)="confirmEditing('email', emp[0].identificadorFiscal)">
                <i class="fas fa-check"></i>
              </button>
              <button class="icon-btn" (click)="cancelEditing()">
                <i class="fas fa-times"></i>
              </button>
            </ng-template>
          </div>

          <div class="data-field">
            <label>{{ 'empresa.telefono_label' | translate }}</label>
            <ng-container *ngIf="!editingField('telefono'); else editTelefono">
              <span>{{ emp[0].telefono }}</span>
              <button class="icon-btn" (click)="startEditing('telefono', emp[0].telefono)">
                <i class="fas fa-edit"></i>
              </button>
            </ng-container>
            <ng-template #editTelefono>
              <input type="text" [(ngModel)]="tempValue" pattern="[0-9]{9}" />
              <button class="icon-btn" (click)="confirmEditing('telefono', emp[0].identificadorFiscal)">
                <i class="fas fa-check"></i>
              </button>
              <button class="icon-btn" (click)="cancelEditing()">
                <i class="fas fa-times"></i>
              </button>
            </ng-template>
          </div>

          <button class="delete-btn" (click)="deleteEnterprise(emp[0].identificadorFiscal)">
            <i class="fas fa-trash"></i> {{ 'empresa.delete_button' | translate }}
          </button>
        </div>
      </ng-template>
    </ng-container>

    <ng-template #cargando>
      <p>Cargando empresa...</p>
    </ng-template>
  </div>
</div>
